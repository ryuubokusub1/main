<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Stone Script Editor</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root {
  --panel-bg: #1e1e1e;
  --panel-fg: #ddd;
  --panel-muted: #9aa0a6;
  --border: #3a3a3a;
}
body {
  margin: 0;
  display: flex;
  height: 100vh;
  flex-direction: column;
  background: #111;
  color: #ddd;
  font-family: sans-serif;
}
header {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 4px;
  position: relative;
}
#editor { height: 100%; }
#docPanel {
  border-left: 1px solid #444;
  padding: 10px;
  background: var(--panel-bg);
}
.panelContent {
  height: 100%;
  overflow: auto;
  padding: 12px 14px;
  line-height: 1.6;
  font-size: 14px;
  white-space: pre-wrap;
  word-break: break-word;
}
.docHeader { padding: 6px 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
.docName { font-weight: 700; color: #fff; }
.muted { color: var(--panel-muted); }
code { background: #00000055; padding: 2px 6px; border-radius: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
#docSearch { flex: 1; font-size: 12px; padding: 2px 4px; background: #252525; color: #ddd; border: 1px solid var(--border); border-radius: 4px; }
#customMenu, #contextMenu { position: absolute; display: none; background: #252525; border: 1px solid #555; color: #ddd; min-width: 140px; z-index: 10000; border-radius: 4px; list-style: none; padding: 0; margin: 0; font-size: 13px; }
#customMenu li, #contextMenu li { padding: 6px 10px; cursor: pointer; }
#customMenu li:hover, #contextMenu li:hover { background: #444; }
.wrap {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr minmax(0, 300px);
  grid-template-rows: auto;
  height: 100%; /* 追加 */
}


#docPanel {
  border-left: 1px solid #444;
  padding: 10px;
  background: var(--panel-bg);
  max-width: 100%; /* 横幅が画面をはみ出さないように */
  overflow: auto;
}

@media (max-width: 600px) {
  .wrap {
    grid-template-columns: 1fr;
    grid-template-rows: 1fr auto; /* 上：editor 下：panel */
  }
  #editor {
    height: calc(100vh - 50px - 50px); /* headerやボタンの高さに応じて調整 */
  }
  #docPanel {
    width: 100%;
    max-height: calc(100vh - 50px); /* パネルも画面内に収める */
    overflow: auto;
    order: 2;
    border-left: none;
    border-top: 1px solid #444;
  }
}

.overlay {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.3);
  display: none; justify-content: center; align-items: center;
  z-index: 99999;
}
.modal {
  background: #fff; border-radius: 8px; padding: 10px; min-width: 400px;
  z-index: 100000; position: relative;
}
.tabs { display: flex; border-bottom: 2px solid #ccc; }
.tab { padding: 8px 16px; cursor: pointer; border: 1px solid #ccc; border-bottom: none; background: #eee; margin-right: 4px; border-radius: 6px 6px 0 0; }
.tab.active { background: #fff; font-weight: bold; }
.tab-content { display: none; }
.tab-content.active { display: block; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
td { border: 1px solid #aaa; padding: 8px; text-align: center; cursor: pointer; }
td:hover { background: #f0f0f0; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.min.js"></script>
</head>
<body>
<header>
  <h2>自作言語エディタ（Stone Script）</h2>
  <span class="muted">補完候補やカーソル位置に応じて右パネルに説明を表示</span>
  <div style="display:flex; gap:8px; margin-top:6px;">
    <button id="menuBtn" style="width:auto; padding:2px 6px;">☰ メニュー</button>
    <button id="openBtn">表を開く</button>
  </div>
  <ul id="customMenu">
    <li data-action="selectAll">すべて選択</li>
    <li data-action="cut">切り取り</li>
    <li data-action="copy">コピー</li>
    <li data-action="paste">貼り付け</li>
  </ul>
</header>

<div class="wrap">
  <div id="editor"></div>
  <aside id="docPanel">
    <div class="docHeader">
      <span class="docName" id="docName">説明パネル</span>
      <input type="text" id="docSearch" placeholder="検索...">
      <span class="muted" id="docMeta">Ready</span>
    </div>
    <div class="panelContent" id="docBody">
      補完候補（<code>Ctrl</code>+<code>Space</code>）や識別子上にカーソルを置くと説明が出ます。
    </div>
  </aside>
</div>

<ul id="contextMenu">
  <li data-action="selectAll">すべて選択</li>
  <li data-action="cut">切り取り</li>
  <li data-action="copy">コピー</li>
  <li data-action="paste">貼り付け</li>
</ul>

<!-- overlay は body の末尾 -->
<div class="overlay" id="overlay">
  <div class="modal" id="modal">
    <div class="tabs">
      <div class="tab active" data-tab="tab1">タブ1</div>
      <div class="tab" data-tab="tab2">タブ2</div>
    </div>
    <div class="tab-content active" id="tab1">
      <table>
        <tr><td>りんご</td><td>みかん</td></tr>
        <tr><td>ぶどう</td><td>バナナ</td></tr>
      </table>
    </div>
    <div class="tab-content" id="tab2">
      <table>
        <tr><td>犬</td><td>猫</td></tr>
        <tr><td>鳥</td><td>魚</td></tr>
      </table>
    </div>
  </div>
</div>

<script>
// Monaco Editor 初期化
require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' } });
require(['vs/editor/editor.main'], function () {
  monaco.languages.register({ id: 'stone_script' });
  monaco.languages.setMonarchTokensProvider('stone_script', {
    tokenizer: {
      root: [
        [/\b(var|if|else|for|function|return|print)\b/, 'keyword'],
        [/"([^"\\]|\\.)*$/, 'string.invalid'],
        [/"/, { token: 'string.quote', bracket: '@open', next: '@string' }],
        [/[0-9]+/, 'number'],
        [/\/\/.*$/, 'comment'],
        [/[a-zA-Z_][a-zA-Z0-9_]*/, 'identifier']
      ],
      string: [
        [/[^\\"]+/, 'string'],
        [/\\./, 'string.escape'],
        [/"/, { token: 'string.quote', bracket: '@close', next: '@pop' }]
      ]
    }
  });

  const DOCS = {
    print: { title: 'print', body: '文字列を出力します\n例:\nprint "Hello World"' },
    if: { title: 'if', body: '条件分岐\nif condition { ... } else { ... }' },
    var: { title: 'var', body: '変数宣言\nvar x = 10' },
    function: { title: 'function', body: '関数定義\nfunction name(params) { ... }' },
    return: { title: 'return', body: '値を返す\nreturn x + 1' },
    for: { title: 'for', body: '反復処理\nfor i = 0..10 { ... }' }
  };

  function s(label, kind, snippet, detail, doc) {
    return { label, kind, insertText: snippet, insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail, documentation: doc };
  }

  monaco.languages.registerCompletionItemProvider('stone_script', {
    provideCompletionItems: () => ({
      suggestions: [
        s('print', monaco.languages.CompletionItemKind.Function, 'print "$1"', '文字を出力', DOCS.print.body),
        s('if', monaco.languages.CompletionItemKind.Keyword, 'if $1 {\n\t$0\n}', '条件分岐', DOCS.if.body),
        s('var', monaco.languages.CompletionItemKind.Keyword, 'var ${1:name} = $0', '変数宣言', DOCS.var.body),
        s('function', monaco.languages.CompletionItemKind.Function, 'function ${1:name}(${2:params}) {\n\t$0\n}', '関数定義', DOCS.function.body),
        s('return', monaco.languages.CompletionItemKind.Keyword, 'return $0', '値を返す', DOCS.return.body),
        s('for', monaco.languages.CompletionItemKind.Keyword, 'for ${1:i} = ${2:0}..${3:10} {\n\t$0\n}', '反復処理', DOCS.for.body)
      ]
    })
  });

  const editor = monaco.editor.create(document.getElementById('editor'), {
    value: 'print "Hello World"\nvar x = 10\nif x {\n\tprint "ok"\n}',
    language: 'stone_script',
    theme: 'vs-dark',
    fontSize: 14,
    lineHeight: 22,
    rulers: [40],
    wordWrap: 'off',
    minimap: { enabled: false },
    automaticLayout: true,
    contextmenu: false,
    suggest: { showWords: true, preview: true, showInlineDetails: true },
    quickSuggestions: { other: true, comments: false, strings: true }
  });

  // ドキュメントパネル更新
  const docNameEl = document.getElementById('docName');
  const docBodyEl = document.getElementById('docBody');
  function updateDocPanel() {
    const pos = editor.getPosition();
    if(!pos) return;
    const word = editor.getModel().getWordAtPosition(pos)?.word;
    const doc = DOCS[word];
    if(doc){
      docNameEl.textContent = doc.title;
      docBodyEl.textContent = doc.body;
    } else {
      docNameEl.textContent = "説明パネル";
      docBodyEl.textContent = "説明はありません。";
    }
  }
  editor.onDidChangeCursorPosition(updateDocPanel);
  editor.onDidChangeModelContent(updateDocPanel);

  // メニュー機能
  const menuBtn = document.getElementById("menuBtn");
  const customMenu = document.getElementById("customMenu");
  menuBtn.addEventListener("click", (e) => {
    const rect = menuBtn.getBoundingClientRect();
    customMenu.style.left = rect.left + "px";
    customMenu.style.top = rect.bottom + "px";
    customMenu.style.display = customMenu.style.display === "block" ? "none" : "block";
    e.stopPropagation();
  });
  document.addEventListener("click", e => {
    if (!customMenu.contains(e.target) && e.target !== menuBtn) customMenu.style.display = "none";
  });
  customMenu.addEventListener("click", e => {
    const action = e.target.dataset.action;
    const selection = editor.getSelection();
    const model = editor.getModel();
    if(!action) return;
    switch(action){
      case "selectAll": editor.setSelection(model.getFullModelRange()); break;
      case "cut":
        navigator.clipboard.writeText(model.getValueInRange(selection));
        editor.executeEdits("", [{ range: selection, text: "" }]);
        break;
      case "copy":
        navigator.clipboard.writeText(model.getValueInRange(selection));
        break;
      case "paste":
        navigator.clipboard.readText().then(text=>{ editor.executeEdits("", [{ range: selection, text }]); });
        break;
    }
    customMenu.style.display = "none";
  });

  // 右クリックメニュー
  const contextMenu = document.getElementById("contextMenu");
  editor.getDomNode().addEventListener('contextmenu', e => {
    e.preventDefault();
    contextMenu.style.display = "block";
    contextMenu.style.left = e.pageX + "px";
    contextMenu.style.top = e.pageY + "px";
  });
  document.addEventListener("click", () => contextMenu.style.display="none");
  contextMenu.addEventListener("click", e=>{
    const action = e.target.dataset.action;
    const selection = editor.getSelection();
    const model = editor.getModel();
    if(!action) return;
    switch(action){
      case "selectAll": editor.setSelection(model.getFullModelRange()); break;
      case "cut":
        navigator.clipboard.writeText(model.getValueInRange(selection));
        editor.executeEdits("", [{ range: selection, text: "" }]);
        break;
      case "copy":
        navigator.clipboard.writeText(model.getValueInRange(selection));
        break;
      case "paste":
        navigator.clipboard.readText().then(text=>{ editor.executeEdits("", [{ range: selection, text }]); });
        break;
    }
    contextMenu.style.display = "none";
  });
});

// 表モーダル
const openBtn = document.getElementById("openBtn");
const overlay = document.getElementById("overlay");
const modal = document.getElementById("modal");
openBtn.addEventListener("click", () => { overlay.style.display = "flex"; });

// タブ切り替え
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

// tdクリックでコピー
document.querySelectorAll(".tab-content").forEach(tabContent => {
  tabContent.addEventListener("click", (e) => {
    const td = e.target.closest("td");
    if(td){
      navigator.clipboard.writeText(td.innerText).then(() => {
        console.log(`コピーしました: ${td.innerText}`);
        overlay.style.display = "none";
      });
    }
  });
});

// モーダル外クリックで閉じる
overlay.addEventListener("click", (e) => {
  if(!modal.contains(e.target)) overlay.style.display = "none";
});
</script>
</body>
</html>
