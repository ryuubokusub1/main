<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Monaco Editor Custom Language</title>
  <style>
    html, body, #container {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    #container {
      width: 100vw;
      height: 100vh;
    }
    @media (max-width: 768px) {
      #container {
        height: calc(100vh - 50px);
      }
      #mobileControls {
        position: fixed;
        bottom: 0;
        width: 100%;
        height: 50px;
        background: #222;
        display: flex;
        justify-content: space-around;
        align-items: center;
        color: white;
        z-index: 10;
      }
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="mobileControls">
    <button onclick="runCode()">‚ñ∂Ô∏è ÂÆüË°å</button>
    <button onclick="document.getElementById('loadInput').click()">üìÇ Èñã„Åè</button>
    <button onclick="saveFile()">üíæ ‰øùÂ≠ò</button>
  </div>
  <input type="file" id="loadInput" style="display: none;">

  <script src="https://unpkg.com/monaco-editor@latest/min/vs/loader.js"></script>
  <script>
    require.config({ paths: { 'vs': 'https://unpkg.com/monaco-editor@latest/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      monaco.languages.register({ id: 'customLang' });

      monaco.languages.setMonarchTokensProvider('customLang', {
        keywords: ['func', 'var', 'for', '?', '!', ':'],
        tokenizer: {
          root: [
            [/\b(func|var|for|\?|!|:)\b/, 'keyword'],
            [/".*?"/, 'string'],
            [/\/\/.*$/, 'comment'],
            [/\/\*/, { token: 'comment', next: '@comment' }],
          ],
          comment: [
            [/[^*]+/, 'comment'],
            [/\*\//, 'comment', '@pop'],
            [/[*]/, 'comment']
          ]
        }
      });

      monaco.languages.registerDefinitionProvider('customLang', {
        provideDefinition(model, position) {
          const word = model.getWordAtPosition(position);
          if (!word) return;
          const regex = new RegExp(`func\\s+${word.word}\\b`);
          const lines = model.getLinesContent();
          for (let i = 0; i < lines.length; i++) {
            if (regex.test(lines[i])) {
              return {
                uri: model.uri,
                range: new monaco.Range(i + 1, 1, i + 1, lines[i].length + 1)
              };
            }
          }
        }
      });

      window.editor = monaco.editor.create(document.getElementById('container'), {
        value: `// customLang example\nfunc greet:\n  "Hello"`,
        language: 'customLang',
        theme: 'vs-dark',
        automaticLayout: true
      });

      editor.onDidChangeModelContent(() => {
        validateCode(editor.getModel());
      });

      function validateCode(model) {
        const code = model.getValue();
        const markers = [];
        if (!code.includes("func")) {
          markers.push({
            severity: monaco.MarkerSeverity.Warning,
            message: "'func' „Åå‰Ωø„Çè„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ",
            startLineNumber: 1,
            startColumn: 1,
            endLineNumber: 1,
            endColumn: 5
          });
        }
        monaco.editor.setModelMarkers(model, 'customLang', markers);
      }

      window.saveFile = function () {
        const blob = new Blob([editor.getValue()], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'code.txt';
        a.click();
      }

      document.getElementById('loadInput').addEventListener('change', function () {
        const file = this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          editor.setValue(reader.result);
        };
        reader.readAsText(file);
      });

      window.runCode = function () {
        alert('„Ç≥„Éº„Éâ„ÇíÂÆüË°å„Åô„ÇãÂá¶ÁêÜ„Çí„Åì„Åì„Å´ËøΩÂä†');
      }
    });
  </script>
</body>
</html>
