<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>簡易コメント</title>
<style>
  body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:20px; max-width:760px; margin:auto;}
  h1{font-size:1.4rem}
  form{display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;}
  input[type="text"]{flex:1; min-width:160px; padding:8px; border:1px solid #ddd; border-radius:6px;}
  textarea{flex-basis:100%; min-height:80px; padding:8px; border:1px solid #ddd; border-radius:6px;}
  button{padding:8px 12px; border-radius:6px; border:0; background:#0366d6; color:white; cursor:pointer;}
  .comment{border-bottom:1px solid #eee; padding:10px 0;}
  .meta{color:#666; font-size:0.85rem; margin-bottom:6px;}
  .empty{color:#999}
  .notice{font-size:0.9rem; color:#444}
</style>
</head>
<body>
  <h1>コメント</h1>
  <p class="notice">簡易デモです。投稿は公開されます。</p>

  <form id="commentForm">
    <input id="name" type="text" placeholder="名前（任意）" maxlength="100">
    <textarea id="comment" placeholder="コメントを入力（最大1000文字）" maxlength="1000"></textarea>
    <div style="width:100%; display:flex; justify-content:flex-end;">
      <button id="send" type="submit">投稿</button>
    </div>
  </form>

  <div id="comments"></div>

<script>
const API_URL ="https://script.google.com/macros/s/AKfycbwU5L1KUDVTcqsX9GGLq-mEJjH91S2GOT-kdH0s5dZExSqHUCzgHmot9MPcBGcHCB4y/exec";


// HTMLエスケープ（簡易）
function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

async function loadComments(){
  const el = document.getElementById('comments');
  el.innerHTML = '<p class="empty">読み込み中...</p>';
  try {
    const res = await fetch(API_URL + '?action=list', { method:'GET', cache:'no-cache' });
    const data = await res.json();
    if (!data.ok){ el.innerHTML = '<p class="empty">読み込みエラー</p>'; return; }
    const comments = data.comments;
    if (!comments || comments.length===0){
      el.innerHTML = '<p class="empty">まだコメントはありません。</p>';
      return;
    }
    el.innerHTML = '';
    comments.forEach(c => {
      const d = new Date(c.timestamp);
      const timeStr = isNaN(d.getTime()) ? c.timestamp : d.toLocaleString();
      const node = document.createElement('div');
      node.className = 'comment';
      node.innerHTML = `<div class="meta"><strong>${escapeHtml(c.name||'名無し')}</strong> ・ ${escapeHtml(timeStr)}</div><div class="body">${escapeHtml(c.comment)}</div>`;
      el.appendChild(node);
    });
  } catch (err) {
    el.innerHTML = '<p class="empty">読み込みに失敗しました。</p>';
    console.error(err);
  }
}

document.getElementById('commentForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const comment = document.getElementById('comment').value.trim();
  if (!comment){ alert('コメントを入力してください'); return; }
  document.getElementById('send').disabled = true;
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, comment })
    });
    const data = await res.json();
    if (data.ok){
      // 投稿成功したらリスト再読込。簡易にフォームをクリア。
      document.getElementById('comment').value = '';
      document.getElementById('name').value = '';
      await loadComments();
    } else {
      alert('投稿に失敗しました: ' + (data.error||'unknown'));
    }
  } catch (err) {
    alert('投稿に失敗しました（ネットワークエラー）');
    console.error(err);
  } finally {
    document.getElementById('send').disabled = false;
  }
});

// 初回ロード
loadComments();

// （任意）数秒ごとに自動更新したければ setInterval(loadComments, 10000);
</script>
</body>
</html>
